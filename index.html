<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ENOC — Estados No Ordinarios de Conciencia</title>
    
  <!-- Web3 + Web3Modal + WalletConnect (CDNs) -->
    <link rel="stylesheet" href="style.css"> 
</head>
<body>
    <main class="page">
        <div class="hero">
            <div class="hero-inner">
                <img src="logo.png" alt="ENOC logo" class="logo" />
                <h1 class="title">ENOC</h1>
                <p class="subtitle">Estados No Ordinarios de Conciencia — Token en Polygon (ENOC)</p>

                <div class="dashboard">
                    <h3>Comprar ENOC en la App</h3>
                    <div class="status-box">
                        <p id="statusText" class="status-msg">Iniciando...</p>

                        <div id="notConnectedPanel">
                            <button id="btnConnect" class="btn primary">Conectar Wallet</button>
                        </div>

                        <div id="connectedPanel" style="display: none;">
                            <p>Wallet Conectada:</p>
                            <p>Cuenta: <code id="account"></code></p>
                            <p>Chain ID: <code id="chain"></code></p>
                            
                            <div class="buy-interface">
                                <input type="number" id="amountUSDT" placeholder="Cantidad de USDT a gastar" min="0.01" step="0.01" />
                                <button id="btnBuy" class="btn primary">Comprar ENOC (Swap)</button>
                            </div>
                            
                            <button id="btnDisconnect" class="btn alt">Desconectar</button>
                        </div>
                    </div>
                </div>

                <div class="meta">
                    <div class="contract">
                        <label>Contrato</label>
                        <div class="contract-row">
                            <code id="contract">0xab8DF9213d13a3cDe984A83129e6acDaCBA78633</code>
                            <button id="copyBtn" class="ghost">Copiar</button>
                        </div>
                    </div>

                    <div class="links">
                        <a id="btnQuickSwap" class="btn primary" target="_blank" rel="noopener">Comprar en QuickSwap</a>
                        <a id="btnScan" class="btn ghost" target="_blank" rel="noopener">Ver en PolygonScan</a>
                        <a href="https://t.me/enocon" class="btn alt" target="_blank" rel="noopener">Telegram</a>
                    </div>
                </div>

                <p class="desc">
                    ENOC es un token experimental en Polygon, creado para explorar modelos comunitarios, transparencia y crecimiento consciente.
                </p>

                <p class="credit">© ENOC — Proyecto comunitario</p>
            </div>
        </div>

        <div id="bg-stars" class="bg-stars" aria-hidden="true"></div>
        <div id="bg-portal" class="bg-portal" aria-hidden="true"></div>
    </main>
    
    <script src="https://unpkg.com/web3@latest/dist/web3.min.js"></script>
    <script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
    <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

    <script>
        // =========================================================
        // CONSTANTES DEL CONTRATO Y DEX
        // =========================================================
        const CONTRACT = "0xab8DF9213d13a3cDe984A83129e6acDaCBA78633";
        const USDT = "0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174";
        const ENOC = CONTRACT;
        const QUICKSWAP_ROUTER = "0xa5E0829CaCEd8fFDD4De3c43696c57F7D7A678ff"; 
        const POLYGON_RPC = "https://polygon-rpc.com";
        const CHAIN_ID = 137; // Polygon Mainnet

        const quickswapURL = `https://quickswap.exchange/#/swap?outputCurrency=${ENOC}&inputCurrency=${USDT}`;

        // =========================================================
        // ABIs
        // =========================================================
        const ERC20_ABI = [
            {"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"type":"function"},
            {"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],"name":"allowance","outputs":[{"name":"","type":"uint256"}],"type":"function"},
            {"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"type":"function"},
            {"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"type":"function"}
        ];

        const ROUTER_ABI = [
            {
                "name": "swapExactTokensForTokensSupportingFeeOnTransferTokens",
                "type": "function",
                "inputs": [
                    { "type": "uint256", "name": "amountIn" },
                    { "type": "uint256", "name": "amountOutMin" },
                    { "type": "address[]", "name": "path" },
                    { "type": "address", "name": "to" },
                    { "type": "uint256", "name": "deadline" }
                ],
                "outputs": [],
                "stateMutability": "nonpayable"
            }
        ];

        // =========================================================
        // STATE & UI refs
        // =========================================================
        let web3Modal;
        let provider;
        let web3;
        let selectedAccount;
        
        const statusText = document.getElementById("statusText");
        const notConnectedPanel = document.getElementById("notConnectedPanel");
        const connectedPanel = document.getElementById("connectedPanel");
        const accountEl = document.getElementById("account");
        const chainEl = document.getElementById("chain");

        function setStatus(msg) {
            console.log("[STATUS]", msg);
            if (statusText) statusText.innerText = msg;
        }

        function updateUI(account, chainId) {
            if (accountEl) accountEl.innerText = account || "";
            if (chainEl) chainEl.innerText = chainId || "";
            if (notConnectedPanel) notConnectedPanel.style.display = "none";
            if (connectedPanel) connectedPanel.style.display = "block";
        }

        function resetUI() {
            if (accountEl) accountEl.innerText = "";
            if (chainEl) chainEl.innerText = "";
            if (statusText) statusText.innerText = "Desconectado";
            if (notConnectedPanel) notConnectedPanel.style.display = "block";
            if (connectedPanel) connectedPanel.style.display = "none";
        }

        // =========================================================
        // INIT WEB3Modal (desktop fallback) - keep but we'll prioritize WalletConnect on mobile
        // =========================================================
        function initWeb3Modal() {
            try {
                const isMobile = /Mobi|Android/i.test(navigator.userAgent);
                const providerOptions = {
                    walletconnect: {
                        package: window.WalletConnectProvider?.default || window.WalletConnectProvider,
                        options: {
                            rpc: { [CHAIN_ID]: POLYGON_RPC },
                            network: "polygon",
                            qrcode: !isMobile
                        }
                    }
                };
                const Web3ModalConstructor = (window.Web3Modal && window.Web3Modal.default) ? window.Web3Modal.default : window.Web3Modal;
                if (!Web3ModalConstructor) {
                    console.warn("Web3Modal no disponible desde CDN");
                    return;
                }
                web3Modal = new Web3ModalConstructor({ cacheProvider: true, providerOptions, theme: "dark" });
                console.log("Web3Modal inicializado");
            } catch (e) {
                console.warn("initWeb3Modal error:", e);
            }
        }

        // =========================================================
        // CONNECT FLOWS
        //  - prefer injected provider if present (MetaMask in-app)
        //  - on mobile: prefer direct WalletConnectProvider (deep-link qrcode:false)
        //  - fallback: Web3Modal
        // =========================================================
        async function connectWithWalletConnectDirect() {
            setStatus("Conectando con WalletConnect...");
            const WCPkg = window.WalletConnectProvider?.default || window.WalletConnectProvider;
            if (!WCPkg) throw new Error("WalletConnectProvider no está disponible");

            // qrcode:false para forzar deep-link en móviles; en desktop puedes usar qrcode:true
            const wcProvider = new WCPkg({
                rpc: { [CHAIN_ID]: POLYGON_RPC },
                qrcode: false
            });

            // provider.enable() genera la URI y en móviles abrirá el deep link
            await wcProvider.enable();
            return wcProvider;
        }

        async function onConnect() {
            const isMobile = /Mobi|Android/i.test(navigator.userAgent);
            setStatus("Iniciando conexión...");

            try {
                // 1) Si hay provider inyectado y estamos dentro de una wallet-app in-app, usarlo (MetaMask in-app)
                if (window.ethereum && window.ethereum.request) {
                    try {
                        setStatus("Solicitando cuentas al provider inyectado...");
                        await window.ethereum.request({ method: 'eth_requestAccounts' });
                        provider = window.ethereum;
                        web3 = new window.Web3(provider);
                        subscribeProvider(provider);
                        const accounts = await web3.eth.getAccounts();
                        selectedAccount = accounts[0];
                        const chainId = await web3.eth.getChainId();
                        updateUI(selectedAccount, chainId);
                        setStatus("Conectado (provider inyectado)");
                        return;
                    } catch (errInjected) {
                        console.warn("Error provider inyectado / usuario canceló:", errInjected);
                    }
                }

                // 2) Si estamos en móvil, intentar WalletConnect DIRECTO (deep-link)
                if (isMobile) {
                    try {
                        provider = await connectWithWalletConnectDirect();
                        web3 = new window.Web3(provider);
                        subscribeProvider(provider);
                        const accounts = await web3.eth.getAccounts();
                        selectedAccount = accounts[0];
                        const chainId = await web3.eth.getChainId();
                        updateUI(selectedAccount, chainId);
                        setStatus("Conectado (WalletConnect)");
                        return;
                    } catch (wcErr) {
                        console.warn("WalletConnect directo falló:", wcErr);
                        // continuar a fallback (web3Modal)
                    }
                }

                // 3) Fallback: Web3Modal (desktop or mobile where web3Modal works)
                if (web3Modal) {
                    try {
                        setStatus("Abriendo selector de wallets...");
                        provider = await web3Modal.connect();
                        web3 = new window.Web3(provider);
                        subscribeProvider(provider);
                        const accounts = await web3.eth.getAccounts();
                        selectedAccount = accounts[0];
                        const chainId = await web3.eth.getChainId();
                        updateUI(selectedAccount, chainId);
                        setStatus("Conectado (Web3Modal)");
                        return;
                    } catch (wmErr) {
                        console.warn("Web3Modal connect falló:", wmErr);
                    }
                }

                // 4) Si llegamos aquí, no pudimos conectar
                throw new Error("No se pudo conectar con ninguna wallet (intenta abrir la página en el navegador in-app de tu wallet).");
            } catch (e) {
                console.error("onConnect error:", e);
                setStatus("Conexión fallida");
                if (isMobile) {
                    alert("Conexión fallida. En Chrome Android: intenta abrir esta página desde el navegador interno de MetaMask o Trust Wallet, o verifica que la app de wallet esté instalada.");
                }
            }
        }

        // =========================================================
        // SUBSCRIPTIONS / EVENTS
        // =========================================================
        function subscribeProvider(providerObj) {
            if (!providerObj) return;
            if (providerObj.on) {
                providerObj.on("accountsChanged", (accounts) => {
                    console.log("accountsChanged", accounts);
                    selectedAccount = accounts && accounts[0];
                    if (accountEl) accountEl.innerText = selectedAccount || "";
                });
                providerObj.on("chainChanged", (chainId) => {
                    console.log("chainChanged", chainId);
                    let c = chainId;
                    if (typeof chainId === "string" && chainId.startsWith("0x")) c = parseInt(chainId, 16);
                    if (chainEl) chainEl.innerText = c;
                });
                providerObj.on("disconnect", (err) => {
                    console.log("disconnect", err);
                    onDisconnect();
                });
            } else {
                console.log("Provider no expone .on");
            }
        }

        async function onDisconnect() {
            try {
                if (provider && provider.close) await provider.close();
            } catch (e) { /* ignore */ }
            try {
                if (web3Modal && web3Modal.clearCachedProvider) await web3Modal.clearCachedProvider();
            } catch (e) { /* ignore */ }
            provider = null;
            web3 = null;
            selectedAccount = null;
            resetUI();
            setStatus("Desconectado");
        }

        // =========================================================
        // SWAP (igual que antes)
        // =========================================================
        async function buyENOC() {
            if (!web3 || !selectedAccount) {
                alert("Primero conecta tu wallet.");
                return;
            }
            const amountInput = document.getElementById("amountUSDT").value;
            if (!amountInput || Number(amountInput) <= 0) {
                alert("Ingresa una cantidad válida de USDT.");
                return;
            }
            try {
                setStatus("Preparando swap...");
                const usdtContract = new web3.eth.Contract(ERC20_ABI, USDT);
                let usdtDecimals = 6;
                try { usdtDecimals = Number(await usdtContract.methods.decimals().call()); } catch (e) {}
                const multiplier = Math.pow(10, usdtDecimals);
                const amountInBN = web3.utils.toBN(String(Math.floor(Number(amountInput) * multiplier)));
                if (amountInBN.lte(web3.utils.toBN(0))) { alert("Monto muy pequeño."); return; }

                const allowance = web3.utils.toBN(await usdtContract.methods.allowance(selectedAccount, QUICKSWAP_ROUTER).call());
                if (allowance.lt(amountInBN)) {
                    setStatus("Aprobando USDT al router...");
                    await usdtContract.methods.approve(QUICKSWAP_ROUTER, amountInBN.toString()).send({ from: selectedAccount });
                }

                setStatus("Ejecutando swap...");
                const router = new web3.eth.Contract(ROUTER_ABI, QUICKSWAP_ROUTER);
                const path = [USDT, ENOC];
                const deadline = Math.floor(Date.now() / 1000) + (60 * 10);
                const amountOutMin = 0; // Recomiendo calcular con getAmountsOut + slippage

                await router.methods.swapExactTokensForTokensSupportingFeeOnTransferTokens(
                    amountInBN.toString(),
                    amountOutMin,
                    path,
                    selectedAccount,
                    deadline
                ).send({ from: selectedAccount, gas: 800000 });

                setStatus("Swap enviado. Revisa tu wallet / Polygonscan.");
            } catch (err) {
                console.error("swap error:", err);
                setStatus("Error en la transacción.");
                alert("Error en la transacción. Ver consola remota.");
            }
        }

        // =========================================================
        // INIT & EVENTS
        // =========================================================
        document.getElementById("btnConnect").addEventListener("click", onConnect);
        document.getElementById("btnDisconnect").addEventListener("click", onDisconnect);
        document.getElementById("btnBuy").addEventListener("click", buyENOC);

        document.getElementById("contract").innerText = CONTRACT;
        document.getElementById("btnQuickSwap").href = quickswapURL;
        document.getElementById("btnScan").href = `https://polygonscan.com/token/${CONTRACT}`;

        document.getElementById("copyBtn").addEventListener("click", async () => {
            try {
                await navigator.clipboard.writeText(CONTRACT);
                const btn = document.getElementById("copyBtn");
                btn.innerText = "Copiado";
                setTimeout(()=> btn.innerText = "Copiar", 1500);
            } catch (e) {
                alert("No se pudo copiar. Copia manualmente: " + CONTRACT);
            }
        });

        window.addEventListener("load", () => {
            initWeb3Modal();
            setStatus("Listo. Pulsa 'Conectar Wallet'.");
            if (web3Modal && web3Modal.cachedProvider) {
                setTimeout(()=> onConnect(), 300);
            }
        });
    </script>
</body>
</html>
